<html lang="en">

<head>
  <title>Select the restaurant of your dreams</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body>

	<script type="text/javascript" src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
	<script type="text/javascript" src="https://code.jquery.com/ui/1.11.0/jquery-ui.min.js"></script>
	<link rel="stylesheet" media="all" type="text/css" href="https://code.jquery.com/ui/1.11.0/themes/smoothness/jquery-ui.css" />

	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery-ui-timepicker-addon/1.6.3/jquery-ui-timepicker-addon.js"></script>
  <link rel="stylesheet" media="all" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-ui-timepicker-addon/1.6.3/jquery-ui-timepicker-addon.css" />

  <h2>Select the restaurant of your dreams...</h2>

  
  <script>
  "use strict";
  $(
    function() {
     var datepicker = $( "#datepicker_id" );
     var restaurant_time_ranges; // propagated later
     datepicker.datetimepicker( {
       stepMinute: 15,
       onSelect: function (selectedDateTime){
         // if they change day or anything this is triggered (i.e. even early)...
          var date = datepicker.datetimepicker('getDate');
          new_date_input_selected(date);
         }
     });
     
     $.getJSON("rest_hours.json", function(data){
       restaurant_time_ranges = parse_all_restaurants(data);
     });
    }
   );
   
   function parse_all_restaurants(data) {
     // data is ["name": "Bai Thong Thai Cuisine", "times": ["Mon-Sat 11 am - 11 pm", "Sun 11 am - 10 pm"] ...]
     // desired output: [ranges: [[day_of_week, start_minute, end_minute], ... ]
     var output = [];
     for(var i=0; i < data.length; i++){
       output.push(parse_single_restaurant_to_ranges(data[i]));
     }
   
     // TODO add divs for them
   }
   
   function parse_single_restaurant_to_ranges(restaurant) {
     var output = [];
     var day_ranges = restaurant.times;
     for(var i=0; i < day_ranges.length; i++){
       var day_range = day_ranges[i];
       output.push(parse_single_range(day_range)); // XXXX can it push on multiples?
     }
   }
   
   function parse_single_range(day_range) {
      // day_range: 
      // "Sun 11 am - 10:30 pm"
      // "Mon-Sat 11 am - 11 pm"
      // "Mon-Thu, Sun 10 am - 10:30 pm"      
      var whereNumbersStart = day_range.search(/\d/); // only want to split it in 2
      var allDays = day_range.substring(0, whereNumbersStart - 1); // Mon-Thu, Sun
      var times = day_range.substring(whereNumbersStart); // 10 am - 10:30 pm (always a single dash, phew)
      var start = hourOfDayToMinutes(times.split(" - ")[0]);
      var end = hourOfDayToMinutes(times.split(" - ")[1]);
      // XXXX accomodate wrapping...
      
      var daysSplit = allDays.split("-");
      var output = [];
      for(var i=0; i < daysSplit.length; i++) {
        var dayInt = stringToWeekDay(daysSplit[i]);
        output.push({day: dayInt, start: start, end: end});
      }
      return output;
   }
   
   function hourOfDayToMinutes(timeString) { 
     // like "10 am" or "10:30 pm" (hours never above 12)
     // based on https://stackoverflow.com/a/2188651/32453 (it was either that or include a library, to be able to handle 12:00 AM right etc. so use this for now...)
     var time = timeString.match(/(\d+)(:(\d\d))?\s*(p?)/i); 

     var pm = time[4];
     var hours = parseInt(time[1], 10);
     if (hours == 12 && !pm) {
       hours = 0;
     }
     else {
      hours += (hours < 12 && pm)? 12 : 0;
     }
     
     var minutes = time[3] ? parseInt(time[3], 10) : 0;
     return hours * 60 + minutes;
   }
   
   function stringToWeekDay(day) {
     return ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"].indexOf(day); // javascript doesn't seem to have a lightweight way to do this :|
   }
   
   function new_date_input_selected(date) {
     var day_of_week = date.getDay(); // day of the week (0 is sunday)
     // TODO ...
   }
   
   function assert_range_parses(time_range, expected) {
     var parsed = parse_single_range(time_range);
     // not sure how to do straight =='s here...
     console.assert(JSON.stringify(parsed) == JSON.stringify(expected), {"message": "parsed range wrong", "parsed": parsed, "expected": expected} ); 
   }
   
   function assert_time_parses(timeString, expectedMinutes) {
     var parsed = hourOfDayToMinutes(timeString);
     console.assert(parsed == expectedMinutes, {"message": "parsed time wrong", "parsed": parsed, "expected": expectedMinutes, "timeString": timeString});
   }
   
   function do_unit_tests() {
     assert_time_parses("12 pm", 12*60);
     assert_time_parses("12 am", 0);
     assert_time_parses("12:30 am", 30);
     assert_time_parses("1 am", 60);
     assert_time_parses("1:30 am", 90);
     assert_time_parses("10 am", 10*60);
     assert_time_parses("12:30 pm", 12*60 + 30);
     assert_time_parses("1:00 pm", 13*60);
     assert_time_parses("1:30 pm", 13*60 + 30);
     assert_time_parses("11:30 pm", 23*60 + 30);
     assert_time_parses("11:59 pm", 23*60 + 59);
     assert_range_parses("Mon 11 am - 11 pm", [{day: 1, start: (11*60), end: (23*60)}]);
     assert_range_parses("Mon-Tue 11 am - 11 pm", [{day: 1, start: (11*60), end: (23*60)}, {day: 2, start: (11*60), end: (23*60)}]);
     assert_range_parses("Mon-Wed 11 am - 11 pm", [{day: 1, start: (11*60), end: (23*60)}, {day: 2, start: (11*60), end: (23*60)}, {day: 3, start: (11*60), end: (23*60)}]);
     console.log("done unit tests");
   }
   
   do_unit_tests();
   
  </script>

  <p>Date: <input type="text" id="datepicker_id"></p>


</body>

</html>